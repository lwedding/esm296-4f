---
title: "Lab 1: Global Wind Production with ArcPy"
author: "Ben Best"
date: "October 1, 2014"
output: 
  html_document:
    toc: true
    toc_depth: 4
    fig_caption: true
    number_sections: true
    self_contained: true
---

# Introduction

**Goal**. You've been tasked by the United Nations to assess countries with highest possible wind energy production.

This lab, similar to the wind siting analysis Lab 3 from ESM 263 (GIS), has you examining wind data for wind farm site suitability. However here we'll only be looking at the wind production aspect globally and not other finer scale suitability components. Although simplified in that sense we'll be adding a few dimensions:

- **Time**. Rather than being provided average wind production throughout the year, you're provided with daily wind data for a given year. The task then is to work out an annual average. This introduces analysis in time and necessitates a looping strategy. We'll show you how to do this in Model Builder with Iterators and programmatically in Python. You'll learn only the cursory basics in Python for now to complete the task. You'll then create a Script Tool to easily perform the same analysis for any year of data. You'll also learn how to visualize geographic elements temporally using the Time Slider and even outputting a video.

- **Polar Coordinates**. Rather than simply being given the wind speed, you are provided wind speed in the horizontal ($u$) and vertical ($v$) direction. These vectors in a "polar coordinate system" can be translated into the "Cartesian coordinate system" giving us the speed ($s$) using good ol' Pythagorean theorem [^polar]:

  $$
  s = \sqrt{u^2 + v^2}
  $$
  
[^polar]: For details on conversion betwen coordinate systems, see [Wikipedia: Polar coordinate system - Converting between polar and Cartesian coordinates](http://en.wikipedia.org/wiki/Polar_coordinate_system#Converting_between_polar_and_Cartesian_coordinates). Note that the [geographic coordinate system](http://en.wikipedia.org/wiki/Geographic_coordinate_system) and [projected coordinate systems](http://en.wikipedia.org/wiki/Map_projection) are for measuring locations and not angle & magnitude like the polar / Cartesian coordinate systems here.

- **Scientific Data Format**. You'll notice the $u$ and $v$ data files also have a *.nc filename extension which stands for "NetCDF" (Network Common Data Format) developed originally by climate scientists for exchanging scientific data in a variety of structures. Another common open-source scientific data format developed by the remote sensing community is "HDF" (Hierarchical Data Format)[^netcdf-hdf]. In this case the $u$.nc and $v$.nc data represent a cube of dimensions $x$, $y$ and $t$. We'll be extracting a time slice $t$ of the $u$ or $v$ wind values over the $x$ and $y$ direction.

    ![](./img/rubik-cube_x-y-t_sized.png)
    <!-- source: https://docs.google.com/a/nceas.ucsb.edu/drawings/d/1K1ruRAgXhz6A8IgzgD4eXgXZTHakQZ75oF3rWZK1Wv8/edit -->

[^netcdf-hdf]: Details for [NetCDF from UCAR](http://www.unidata.ucar.edu/software/netcdf/) and [HDF from NCSA](http://www.hdfgroup.org/).

Finally, you'll be using the best of breed scientific programming tools to track changes in the files you create (**git**) and publish an executive summary report to an online project management interface (**Github**). You'll make this report in a language (**markdown**) that easily converts to an html web page (and other formats).

# Data

- **NCEP Reanalysis Wind Data**<br>
  http://www.ncdc.noaa.gov/societal-impacts/wind
    - spatial resolution: 2.5 x 2.5 degrees and temporal resolution daily.
    - temporal resolution: daily
    - file format: netcdf (*.nc)
  
    ![_Figure 1. Mean wind speed in USA interpolated to 0.25 x 0.25 degrees._](./img/sig995_wind_201308.gif)
  
- **Natural Earth | 1:10m Cultural Vectors | Admin 0 â€“ Countries**<br>
  http://www.naturalearthdata.com/downloads/10m-cultural-vectors/10m-admin-0-countries/
    - spatial resolution: 1:10m
    - version: 
    - file format: shapefile (*.shp)
    
    ![_Figure 2. Natural Earth administrative boundaries._](./img/natural-earth_admin0_countries.png)

# Methods

## Download Data

You can use the URLs above to download the data or just download the 7-zipped file:

https://purl.org/net/frew/ESM296/wk1/raw.7z

I recommend placing this in `H:\esm296-4f\lab1`, right clicking 7-Zip > Extract here.

## Prep Workspace

Fire up ArcMap and create in the Catalog pane:

- a new blank map, save it in `H:\esm296-4f\lab1` as `lab1.mxd`.
- new file geodatabase as `lab1.gdb`
- new toolbox as `lab1.tbx`
- new folder `out`

Right click on lab1.gdb to Make Default Geodatabase.

You'll need to have the Spatial Analyst extension ticked on (ArcMap menu Customize > Extensions)

## Extract Raster Layer from NetCDF

Create a new Model within lab1.tbx and Edit it. Set Model > Model Properties to "Store relative path names" and give it a name and label of "uv_nc_to_s_tif".

Now add the [Make NetCDF Raster Layer](http://resources.arcgis.com/en/help/main/10.2/index.html#//004300000006000000) tool navigate to the input file `raw/uwnd.sig995.2013.nc` (note: `u` and `2013`) with further parameters like so:

![](img/arc_make-netcdf-raster-layer_params.png)

Run this tool to see the output in ArcMap. You might need to right-click on the output  Add To Display.

Repeat for the `v` and `2013` file, swapping out instances of `u` for `v`.

## Calculate Speed from U and V Winds

Now we're ready to calculate the speed $s$ given vectors $u$ and $v$ using the [Raster Calculator](http://resources.arcgis.com/en/help/main/10.2/index.html#//009z000000z7000000). Apply the equation

  $$
  s = \sqrt{u^2 + v^2}
  $$

by entering the following parameters, choosing the variables (green triangle) and not layers (yellow diamond).

  ![](img/arc_raster-calculator_params.png)

Notice the output is `in_memory\s_001` since we're not quite to the final product so don't need to write to disk just yet. This uses the [`in_memory` workspace](http://resources.arcgis.com/en/help/main/10.2/index.html#//002w0000005s000000) so the interim output is not written to disk, but simply kept in memory for your session, like a layer.


## Resample Raster

If you add a global basemap (File > Add Data > Add Basemap...) and make just `s_001` visible with some transparency, you'll notice that this is much chunkier than Figure 1 above since that was resampled at 0.25 x 0.25 degrees from the original global 2.5 x 2.5 degrees raster. Let's do the same with the [Resample](http://resources.arcgis.com/en/help/main/10.2/index.html#//00170000009t000000) function using BILINEAR interpolation and output to `H:\esm296-4f\lab1\out\s_001.tif`.

At this point export a PNG of your Model for later writeup (Model > Export > To Graphic...) into `H:\github\courses\esm296-4f\lab1\img\uv_nc_to_s_tif.png`.

## Use Iterator in Model Builder

Ok, so we've got a decent product, but that's only the first time index. And there's 365, one for each day of the year. So let's to get loopy!

This really should motivate you to create script, but you might as well also know about [iterators in ModelBuilder](http://resources.arcgis.com/en/help/main/10.2/index.html#//002w0000001w000000). Iterating through all 365 days is overkill for our purposes. Let's just loop over one day per month.

To start, create another model with Save as... `uv_nc_to_s_tif_for_loop`. Add the For iterator by right clicking on empty part of the ModelBuilder canvas > Iterators, and parameterize like so:

- From Value: 1
- To Value: 365
- By Value: 29

Rename the default "value" output to "j" for [julian day](http://en.wikipedia.org/wiki/Julian_day), ie index day of the year. Be careful not to use "i" or "n" which are reserved variables for [ArcGIS inline variable substitution](http://resources.arcgis.com/en/help/main/10.2/index.html#/A_quick_tour_of_using_inline_variable_substitution/002w0000001t000000/). You should see this in your model:

  ![](img/arc-mb_for-j.png)

We can then use this variable in the parameters of the other tools by wrapping it with `%` (an old MS-DOS convention).

  ![](img/arc-mb_make-netcdf-raster-layer_params-for-variable-j.png)

Continue swapping out all instances of `1` or `001` with `%j%` in the function parameters. The working equation for the Raster Calculator is:

```
SquareRoot( Square("u_%j%") + Square("v_%j%") )
```

The link from the u and v input to Raster Calculator gets lost, so you'll need to link `u_%j%` and `v_%j%` to the Raster Calculator as a "precondition" so these get generated first and are available to the Raster Calculator.


## Export to Script

While it gets the job mostly done, there are a few reasons I don't like the above approach:

- The %j% substitution gets squirrely like in Raster Calculator above.
- The outputs don't sort well since they're not zero padded like s_001.tif
- The julian day or index number makes it hard to tell which month it should refer to and it won't be the middle of the month exactly.

This all leads us to doing it right in a Python script. A great way to get started is editing the first model uv_nc_to_s_tif, menu Model > Export > To Python Script... and save to `H:\github\courses\esm296-4f\lab1\uv_nc_to_s_tif.py`.


...Get a command line going...


## Python

Ok, let's start with our motivation.

```python
import antigravity
```

- https://github.com/ipython/ipython/wiki/A-gallery-of-interesting-IPython-Notebooks - the mother load of scientific python computing

- http://www.software-carpentry.org/v5/novice/python/index.html

- **.py** Python script extension

- **arcpy** Python module with ArcGIS functionality

And now using the ArcGIS module `arcpy`. 

```python
import arcpy

# get loopy
for i in xrange(1,4):
  arcpy.RasterCoolio(i)
```

python scripts execute on the command line.

## WinPython

- block indents
- check syntax, running man

## ArcMap Python Command Line

## Time Slider

Raster Catalog code.

```python

```

## Save Report in Markdown

For tips, see: https://help.github.com/articles/markdown-basics

- https://guides.github.com/features/mastering-markdown/
- cheatsheet
- https://stackedit.io for side by side

Trying out http://www.emoji-cheat-sheet.com :zap:. Or https://octicons.github.com (see [usage](https://octicons.github.com/usage/))?

- https://dl.dropboxusercontent.com/u/1250538/296-4F/bash_properties.png

## Git Commit and Push Changes



## Github Close Issue

Check did with commit message above.